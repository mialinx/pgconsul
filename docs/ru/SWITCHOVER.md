# SWITCHOVER

switchover - это процесс планового переключения мастера на другой хост.

Можно условно выделить два варианта:
* "failover to" - когда заранее новый мастер известен заранее и важно переключиться именно на него
* "failover from" - когда подойдет любая реплика, главное освободить текущий мастер

## Процесс switchover

switchover начитается с того, что CLI или worker записывает в `SWITCHOVER_STATE_PATH` значение `scheduled`,
а в `SWITCHOVER_PRIMARY_PATH` информацию откуда и куда нужно переключить мастер.

Процесс switchover осуществляется одновременно старым мастером и репликой-кандидатом, которые синхронизуются через установку и ожидание значений в ZK.

### Проверка необходимости

Текущий мастер проверяет (`_check_primary_switchover`), что:

* его текущая роль - действительно мастер
* команда на switchover актуальна:
    * ее состояние - `scheduled`
    * `hostname` откуда переключаться совпадает с текущим мастером
    * таймлайн записанный в команде совпадает с таймлайном текущего мастера
* если с последнего switchover/failover прошло мало времени, проверяет что все HA реплики успели вернуться в кластер и живы
* кластер не находится в процессе failover-а
* кандидат, на которого будет переключение, является синхронной/кворумной репликой и не отстает
* передает выбранного кандидата в `_do_primary_switchover`

Все реплики выполняют примерно те же проверки, но в отдельной функции `_detect_replica_switchover`.

### Переключение мастера

Старый мастер (`_do_primary_switchover`):
* фиксирует выбранного в `_check_primary_switchover` кандидата в ZK. С этого момента кандида не может поменяться.
* делает выбранного кандидата единственной синхронной репликой. Это гаранитирует что на нем будут все транзакции старого мастера.
* сигнализирует реплике, записывая в `SWITCHOVER_STATE_PATH` значение `initiated`

Все реплики (`_accept_switchover`):
* дожидаются сигнала от мастера о начале процедуры switchover
* получают выбранного старым мастером кандидата из ZK.
* если реплика является не кандидатом, она поворачивается на кандидата
* если реплика является кандидатом, она продолжает процедуру переключения как новый мастер

Новый мастер (`_accept_switchover`):
* сигнализирует мастеру о готовности, записывая в `SWITCHOVER_STATE_PATH` значение `candidate_found`

Старый мастер (`_do_primary_switchover`):
* ожидает сигнала от готовности кандидата
* делает `CHECKPOINT`
* закрывается от нагрузки (останавливает Pooler)
* дожидается когда новый мастер догонит репликацию до lag < `max_allowed_switchover_lag_ms`
* начинает остановку Postgres в фоне
* ждет 5 секунд
* отпускает  `leader_lock`

Новый мастер (`_accept_switchover`):
* ожидает освобождения и захватывает `leader_lock`
* создает слоты репликации на новом мастере
* собственно делает pg_ctl promote
* очищает в ZK информацию о switchover

Старый мастер
* дожидается полной остановки Postgres
* дожидается пока новый мастер захватывает `leader_lock` и возвращается в кластер как реплика
